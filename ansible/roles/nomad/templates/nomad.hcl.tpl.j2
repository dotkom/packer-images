data_dir = "/opt/nomad"
bind_addr = "0.0.0.0"

datacenter = "{{nomad_datacenter}}"

leave_on_terminate = true

client {
  enabled          = true
}

tls {
  http = true
  rpc  = true

  ca_file   = "/etc/nomad.d/ca.crt"
  cert_file = "/etc/nomad.d/agent.crt"
  key_file  = "/etc/nomad.d/agent.key"

  verify_server_hostname = true
  verify_https_client    = true
}

plugin "raw_exec" {
  config {
    enabled = true
  }
}

consul {
  token = "{{ with secret "secret/data/consul/acl/nomad-client" }}{{ .Data.data.key }}{{ end }}"
}

telemetry {
  collection_interval = "1s"
  disable_hostname = true
  prometheus_metrics = true
  publish_allocation_metrics = true
  publish_node_metrics = true
}

vault {
  enabled          = true
  tls_skip_verify  = true
  address          = "https://vault.service.consul:8200"
  create_from_role = "nomad-cluster"
}