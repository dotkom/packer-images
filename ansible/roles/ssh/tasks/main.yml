
---
- name: Place trusted user ca
  copy:
    content: "{{ ssh_trusted_user_ca }}"
    dest: /etc/ssh/trusted-user-ca-keys.pem

- name: Configure sshd
  lineinfile:
    path: "/etc/ssh/sshd_config"
    regex: "^(#)?{{item.key}}"
    line: "{{item.key}} {{item.value}}"
    state: present
  loop:
    - { key: "PermitRootLogin", value: "no" }
    - { key: "PasswordAuthentication", value: "no" } 
    - { key: "TrustedUserCAKeys", value: "/etc/ssh/trusted-user-ca-keys.pem" }
    
- name: Restart sshd
  service:
    name: sshd
    enabled: true
    state: restarted
