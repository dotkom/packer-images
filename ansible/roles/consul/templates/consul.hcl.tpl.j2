#jinja2:variable_start_string:'[%', variable_end_string:'%]', trim_blocks: False
{% if consul_server %}

server                 = true
verify_incoming        = true
key_file               = "/etc/consul.d/agent.key"
cert_file              = "/etc/consul.d/agent.crt"
bootstrap_expect = [% consul_bootstrap_expect %] 

ports {
  https = 8501
  grpc = 8502
}

retry_join_wan = ["provider=azure tag_name=[% consul_auto_join_key %] tag_value=[% consul_auto_join_value %]"]

ui_config {
  enabled = true
  metrics_provider = "prometheus"
  metrics_proxy {
    base_url = "http://prometheus.service.consul:9999"
  }
}
advertise_addr_wan = "{{ sockaddr "GetPublicIP" }}"

telemetry { 
  disable_compat_1.9 = true 
  disable_hostname = true
  prometheus_retention_time = "30s"
}

rpc {
  enable_streaming = true
}

connect {
  enabled = true
}

auto_encrypt {
  allow_tls = true
}

{% else %}

verify_incoming        = false

ports {
  grpc = 8502
}

auto_encrypt = {
  tls = true
}

{% endif %}


node_name              = "{{ env "CONSUL_NODE_NAME" }}"
datacenter             = "[% consul_datacenter  %]"
primary_datacenter     = "[% consul_primary_datacenter  %]"

data_dir               = "/opt/consul"
verify_outgoing        = true
verify_server_hostname = true

ca_file                = "/etc/consul.d/ca.crt"

encrypt = "{{ with secret "secret/data/consul/encrypt" }}{{ .Data.data.key }}{{ end }}"

acl {
  enabled                  = true
  default_policy           = "deny"
  enable_token_persistence = true
  enable_token_replication = true
  tokens = {
    {% if consul_server %}
    master = "{{ with secret "secret/data/consul/acl/master" }}{{ .Data.data.token }}{{ end }}"
    {% endif %}
    default = "{{ with secret "secret/data/consul/acl/[% consul_acl_secret_path %]" }}{{ .Data.data.token }}{{ end }}"
  }
}

enable_script_checks = false
disable_remote_exec = true

advertise_addr = "{{ sockaddr "GetPrivateIP" }}"
client_addr = "0.0.0.0"
bind_addr = "0.0.0.0"

translate_wan_addrs = true

retry_join = ["provider=aws tag_key=[% consul_auto_join_key %] tag_value=[% consul_auto_join_value %]"]
